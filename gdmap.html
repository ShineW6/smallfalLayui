<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="chrome=1">
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
		<title>高德地图</title>
		<style type="text/css">
			#myPageTop {
			    width: 980px;
			    background: #FFF;
			    margin: 10px auto;
			    padding: 0 0 10px 10px;
			    border: 1px solid #ccc;
			}
			
		    #myPageTop table{ border-spacing: 0; width:100%; }
			#myPageTop td{ text-align: left; width:50%; height: 30px; line-height: 30px; padding:0; }
			#myPageTop .tr-radio input{ margin: 0 3px; vertical-align: -3px; }
			#myPageTop .tr-radio label{ margin: 0 20px 0 0; }
			#myPageTop .tr-text input{ margin:0 10px 0 0; height: 24px; padding:0 4px; width: 280px;  line-height:1.5; *line-height: 24px;line-height: 24px\0; }
			#myPageTop .btn-search{ background: #0075C2; display: inline-block; height: 28px; line-height: 28px; padding: 0 20px; text-decoration: none; color: #fff; }
			#myPageTop a.picker-copy{ font-size:15px; }
			#myPageTop .btn-search:hover, #myPageTop .btn-search:focus{ background:#3391CE;  }	
			
	      body,html,#container{
	        height: 100%;
	        margin: 0px;
	      }
	      #container{
	      	border: solid 1px #3391CE;
	      }
	    </style>
	    </head>
	    <script src="http://webapi.amap.com/maps?v=1.3&key=c5e898ba0e051c0a1b2aee69adf13ac2&plugin=AMap.Geocoder"></script>
		<script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
	    <body>
	    	<div id="hd" class="barn clearfix">
				<div id="myPageTop">
					<table>
						<tbody><tr class="tr-radio">
							<td>
								按关键字搜索
								<span id="txtSearchMessage" class="message hide" style="display: block;">请输入搜索内容！</span>
								<input class="txt" id="address" name="address" type="hidden">
							</td>
							<td>
								当前坐标
							</td>
						</tr>
						<tr class="tr-text">
							<td>
								<input type="text" name="search" id="txtSearch" placeholder="请输入关键字进行搜索">
								<a href="javascript:;" title="搜索" id="btn-search" class="btn-search" onClick="searchArea()">搜索</a>
							</td>
							<td>
								<input type="text" id="txtCoordinate" name="coordinate" readonly="">
								<a href="javascript:;" title="确定" id="btn-ok" class="btn-search" style="background:green;" onClick="submitMap()">确定</a>
								<a href="javascript:;" title="关闭" id="btn-cancel" class="btn-search" style="background:red;" onClick="cancel()">关闭</a>
							</td>
						</tr>
					</tbody></table>
				</div>
			</div>
	    	<div id="container" tabindex="0"></div>
	    <script type="text/javascript" src="js/jquery.min.js" ></script>
	    <script type="text/javascript" src="plugins/layui/layui.js"></script>
	    <script type="text/javascript" src="js/com.js"></script>
		<script type="text/javascript">
		 var lng = null;
         var lat = null;	
		
			  var map = new AMap.Map('container', {
			       resizeEnable: true
			   });
			  
		 function submitEnter() {
            if ($("#address").val().trim() == "") {
//              showMsg("请输入地址并确定地图上的位置！", "error");
                alert("请输入地址并确定地图上的位置！");
                return;
            }
            if (lng == null || lat == null) {
//              showMsg("请选取地图上的位置！", "error");
                alert("请点击地图上标记的位置！");
                return;
            }
	            window.parent.setAddress($("#txtSearch").val().trim(), lng, lat);
	        }
	        function cancel() {
	            window.parent.cancelAddress();
	        }
	        function submitMap() {
	            if (lng == null || lat == null) {
	            	alert("请选取地图上的位置！");
//	                showMsg("请选取地图上的位置！", "error");
	                return;
	            }
	            window.parent.setAddress($("#address").val().trim(), lng, lat);
        }
        
			  function searchArea(){
			  	 var area = document.getElementById("txtSearch").value;
			  	 positiveGeocoder(area);
			  };
			  
			  function reSetMap(lng,lat){
			  	 map.setZoom(14);
				 map.setCenter([lng,lat]);
			  }

			  function positiveGeocoder(area) {
			        var geocoder = new AMap.Geocoder({
			            radius: 1000 //范围，默认：500
			        });
			        //地理编码,返回地理编码结果
			        geocoder.getLocation(area , function(status, result) {
			            if (status === 'complete' && result.info === 'OK') {
			                positiveGeocoder_CallBack(result);
			            }else{
				       alert("获取地址失败");
				    }
			        });
			    }
			  
			  function inverseGeocoder(lng,lat) {
			  	 var lnglatXY = [lng , lat];
			  	 var geocoder = new AMap.Geocoder({
			            radius: 1000 //范围，默认：500
			        });
			        //地理编码,返回地理编码结果
			  	 geocoder.getAddress(lnglatXY, function(status, result) {
				    if (status === 'complete' && result.info === 'OK') {
				       inverseGeocoder_CallBack(result,lng,lat);
				    }else{
				       alert("获取地址失败");
				    }
				});  
			  }
		      
		       function positiveGeocoderAddMarker(i, d) {
		        var marker = new AMap.Marker({
		            map: map,
		            position: [ d.location.getLng(),  d.location.getLat()]
		        });
		        var infoWindow = new AMap.InfoWindow({
		            content: d.formattedAddress + '   坐标：' + d.location.getLng() + ',' +  d.location.getLat(),
		            offset: {x: 0, y: -30}
		        });
		        marker.on("mouseover", function(e) {
		            infoWindow.open(map, marker.getPosition());
		        });
		        
		    }
		          
		       function inverseGeocoderAddMarker(formattedAddress,lng,lat) {
		        var marker = new AMap.Marker({
		            map: map,
		            position: [ lng , lat]
		        });
		        var infoWindow = new AMap.InfoWindow({
		            content: formattedAddress + '   坐标：' + lng + ',' +  lat,
		            offset: {x: 0, y: -30}
		        });
		        marker.on("mouseover", function(e) {
		            infoWindow.open(map, marker.getPosition());
		        });
		        
		    }
		   
		      function positiveGeocoder_CallBack(data) {
			        var resultStr = "";
			        //地理编码结果数组
			        var geocode = data.geocodes;
			        for (var i = 0; i < geocode.length; i++) {
			            //拼接输出html
			            document.getElementById("address").value = geocode[i].formattedAddress;
			            lng = geocode[i].location.getLng();
			            lat = geocode[i].location.getLat();
			            document.getElementById("txtCoordinate").value = geocode[i].location.getLng() + ',' + geocode[i].location.getLat()
			            resultStr += "<span style=\"font-size: 12px;padding:0px 0 4px 2px; border-bottom:1px solid #C1FFC1;\">" + "<b>地址</b>：" + geocode[i].formattedAddress + "" + "&nbsp;&nbsp;<b>的地理编码结果是:</b><b>&nbsp;&nbsp;&nbsp;&nbsp;坐标</b>：" + geocode[i].location.getLng() + ", " + geocode[i].location.getLat() + "" + "<b>&nbsp;&nbsp;&nbsp;&nbsp;匹配级别</b>：" + geocode[i].level + "</span>";
			            positiveGeocoderAddMarker(i, geocode[i]);
			            reSetMap(geocode[i].location.getLng(),geocode[i].location.getLat());
			        }
			        document.getElementById("txtSearchMessage").innerHTML = resultStr;
			    }
		         
		      function inverseGeocoder_CallBack(data,lng,lat){
		      	   var resultStr = "";
			            //拼接输出html
			            resultStr += "<span style=\"font-size: 12px;padding:0px 0 4px 2px; border-bottom:1px solid #C1FFC1;\">" + "<b>地址</b>：" + data.regeocode.formattedAddress + "" + "&nbsp;&nbsp;<b>的地理编码结果是:</b><b>&nbsp;&nbsp;&nbsp;&nbsp;坐标</b>：" + lng + ", " + lat + "" + "<b>&nbsp;&nbsp;&nbsp;&nbsp;</span>";
			            document.getElementById("address").value = data.regeocode.formattedAddress;
			            inverseGeocoderAddMarker(data.regeocode.formattedAddress,lng,lat);
			            reSetMap(lng,lat);
				        document.getElementById("txtSearchMessage").innerHTML = resultStr;
		      }
		    
		    var clickEventListener = map.on('click', function(e) {
		    	lng = e.lnglat.getLng();
		    	lat = e.lnglat.getLat();
		        document.getElementById("txtCoordinate").value = e.lnglat.getLng() + ',' + e.lnglat.getLat()
                inverseGeocoder(lng,lat);
		    });
		    
		    $(function(){
                   var request = getRequest();
		           lng = request["lng"] == null || request["lng"] == "" ? null : request["lng"];
		           lat = request["lat"] == null || request["lng"] == "" ? null : request["lat"];
		           if (lng != null || lat != null) {
		           	  inverseGeocoder(lng,lat);
		           }
			  });
		</script>
	 </body>
</html>
