<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>平台官方推送</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="plugins/layui/css/layui.css" media="all" />
		<link rel="stylesheet" href="css/webuploader.css" media="all" />
		<link rel="stylesheet" href="css/global.css" media="all">
		<link rel="stylesheet" href="css/reset.css" media="all">
	</head>
	<body>
	   <div class="container" style="width: 70%;">	
		 <div style="margin: 15px;">
		      <span class="layui-breadcrumb">
				  <a  href="javascript:history.back(-1)">推送管理</a>
			  </span>
		 </div>
		 
		<form class="layui-form">
		 <div class="layui-form" style="margin: 17px;">
		 	<div class="layui-form-item">
		 	   <div class="layui-inline">
		 	   	   <select name="provinceId" lay-verify="" lay-filter="province" id="province">
		 	   	   	   <option value="">所属省份</option>
				   </select>
		 	   </div>
		 	   
		 	   <div class="layui-inline">
			 	   	   <select name="cityId" lay-verify="" lay-filter="city" id="city">
			 	   	   	 <option value="">所属城市</option>
					   </select>
		 	   </div>
		 	   
		 	   <div class="layui-inline">
			 	   	   <select name="schoolId" lay-verify="" lay-filter="school" id="school">
							  <option value="">选择学校</option>
					   </select>
		 	   </div>
		 	   
		 	   <div class="layui-inline">
			 	   	   <select name="grade" lay-verify="" lay-filter="grade" id="grade">
			 	   	   	   <option value="">入学年份</option>
					   </select>
		 	   </div>
		 	</div>   
		 	
		 	<div class="layui-form-item">
				 <div class="layui-input-inline" style="width: 75%">
		             <input type="text" name="title" required="" lay-verify="title" placeholder="请输入标题" autocomplete="off" class="layui-input">
		          </div>
		 	 </div> 
		 	 
		 	 <div class="layui-form-item">
				 <div class="layui-input-inline" style="width: 75%">
		             <input type="text" name="url" required="" lay-verify="url" placeholder="请输入链接" autocomplete="off" class="layui-input">
		          </div>
		 	 </div>
		     
		     <div class="layui-form-item">
		     	 <div id="uploadimg"> 
						 <div id="fileList" class="uploader-list"></div> 
						 <div id="imgPicker">选择图片</div> 
					</div>
		     </div>
		      
		      <div class="layui-form-item">
		      	  <textarea id="content" style="display: none;"></textarea>
		      </div>
		   </div>
		   
		    <div style="margin-left:43%;margin-bottom: 30px;">
		    	<button class="layui-btn layui-btn-big" lay-submit lay-filter="up">提交</button>
		    </div>
		 </form>
		 </div>
		 <script type="text/javascript" src="js/jquery.min.js"></script>
		 <script type="text/javascript" src="js/webuploader.min.js"></script>
		 <script type="text/javascript" src="plugins/layui/layui.js"></script>
		 <script type="text/javascript" src="js/com.js"></script>
		 <script type="text/javascript" src="js/underscore-min.js"></script>
		 <script>
             var picture;  
		 	 
		 	 $(function webUploaderInit(){
			        var uploader = WebUploader.create({ 
							 auto: true, // 选完文件后，是否自动上传 
							 swf: '/js/Uploader.swf', // swf文件路径 
							 server: remoteUrl + 'platform/dataServlet.do?flag=uploadPicture', // 文件接收服务端 
							 pick: '#imgPicker', // 选择文件的按钮。可选 
							 // 只允许选择图片文件。 
							 accept: { 
							 title: 'Images', 
							 extensions: 'gif,jpg,jpeg,bmp,png'
//							 mimeTypes: 'image/*' 
							 },
							 compress: {
							 	width: 800,  
							    height: 1200,  
							  
							    // 图片质量，只有type为`image/jpeg`的时候才有效。  
							    quality: 80,  
							  
							    // 是否允许放大，如果想要生成小图的时候不失真，此选项应该设置为false.  
							    allowMagnify: false,  
							  
							    // 是否允许裁剪。  
							    crop: false,  
							  
							    // 是否保留头部meta信息。  
							    preserveHeaders: true,  
							  
							    // 如果发现压缩后文件大小比原来还大，则使用原来图片  
							    // 此属性可能会影响图片自动纠正功能  
							    noCompressIfLarger: false,  
							  
							    // 单位字节，如果图片大小小于此值，不会采用压缩。  
							    compressSize: 0  
							 }
							});
			        
			        uploader.on( 'fileQueued', function( file ) { 
							 var $list = $("#fileList"), 
							 $li = $( 
							 '<div id="' + file.id + '" class="file-item thumbnail">' + 
							 '<img>' + 
							 '<div class="info">' + file.name + '</div>' + 
							 '</div>' 
							 ), 
							 $img = $li.find('img'); 
							 
							 
							 // $list为容器jQuery实例 
							 $list.append( $li ); 
							 
							 // 创建缩略图 
							 uploader.makeThumb( file, function( error, src ) { 
							 if ( error ) { 
							 $img.replaceWith('<span>不能预览</span>'); 
							 return; 
							 } 
							 
							 $img.attr( 'src', src ); 
							 }, 100, 100 ); //100x100为缩略图尺寸 
							});
							
					// 文件上传过程中创建进度条实时显示。 
					uploader.on( 'uploadProgress', function( file, percentage, headers ) { 
					 _.extend(headers, {
							"Origin": "http://localhost:3000",
							"Access-Control-Request-Method": "POST"
							    });
							    
					 var $li = $( '#'+file.id ), 
					 $percent = $li.find('.progress span'); 
					 
					 // 避免重复创建 
					 if ( !$percent.length ) { 
					 $percent = $('<p class="progress"><span></span></p>') 
					 .appendTo( $li ) 
					 .find('span'); 
					 } 
					 
					 $percent.css( 'width', percentage * 100 + '%' ); 
					}); 
					 
					// 文件上传成功，给item添加成功class, 用样式标记上传成功。 
					uploader.on( 'uploadSuccess', function( file, res ) { 
					 $( '#'+file.id ).addClass('upload-state-done');
					 var res = JSON.parse(JSON.stringify(res));
					     picture = res.picName;
					}); 
					 
					// 文件上传失败，显示上传出错。 
					uploader.on( 'uploadError', function( file ) { 
					 var $li = $( '#'+file.id ), 
					 $error = $li.find('div.error'); 
					 
					 // 避免重复创建 
					 if ( !$error.length ) { 
					 $error = $('<div class="error"></div>').appendTo( $li ); 
					 } 
					 
					 $error.text('上传失败'); 
					}); 
					 
					// 完成上传完了，成功或者失败，先删除进度条。 
					uploader.on( 'uploadComplete', function( file ) { 
					 $( '#'+file.id ).find('.progress').remove(); 
				});
			         
		 	});
		 	
		 	 function pushSuccessCallBack(data,form){
		 	 	   var form = form;
		 	 	   var data = JSON.parse(JSON.stringify(data));
		 	 	   if(data.stateCode==0){
		 	 	   	 layer.msg('您已成功发送此条推送', {icon: 1});
		 	 	   }
		 	 	   if(data.stateCode==1){
		 	 	   	 layer.msg('推送发送失败，内容、标题不能为空', {icon: 2});
		 	 	   }
		 	 }
		 	
		 	 function initGrade(form){
		 	 	   var form = form;
		 	 	   var dom = '<option value="-1">入学年份</option>';
 		 	 	   var now = new Date();
 		 	 	   var nowYear = now.getFullYear();
 		 	 	   for(var i=2007;i<=nowYear;i++){
 		 	 	   	dom += '<option value='+i+'>'+i+'</option>'
 		 	 	   }
 		 	 	   $('#grade').html(dom);
	              	form.render('select');
		 	 };
		 	 
		 	 function initSchool(data,form){
		 	 	   var form = form;
		 	 	   var data = JSON.parse(JSON.stringify(data));
		 	 	   var dom = '<option value="-1">选择学校</option>';
	              	for(var i = 0; i < data.schools.length; i++){
	              		dom += '<option value='+data.schools[i].schoolId+'>'+data.schools[i].schoolName+'</option>'
	              	}
	              	$('#school').html(dom);
	              	form.render('select');
		 	 };
		 	
		 	 
		 	 function getProvinceData(data,form){
	              	var form = form;
	              	var data = JSON.parse(JSON.stringify(data));
	              	var dom = '<option value="-1">所属省份</option>';
	              	for(var i = 0; i < data.regions.length; i++){
	              		dom += '<option value='+data.regions[i].regionId+'>'+data.regions[i].regionName+'</option>'
	              	}
	              	$('#province').html(dom);
	              	form.render('select');
              }
		 	 
		 	 function getCityData(data,form){
		 	 	    var form = form;
	              	var data = JSON.parse(JSON.stringify(data));
	              	var dom = '<option value="-1">所属城市</option>';
	              	if(data.regions){
		              	for(var i = 0; i < data.regions.length; i++){
		              		dom += '<option value='+data.regions[i].regionId+'>'+data.regions[i].regionName+'</option>'
		              	}
		            }
	              	$('#city').html(dom);
	              	form.render('select');
              }
		 </script>
		  <script>
		  	        layui.use(['layedit','form'], function(){
					   var layedit = layui.layedit;
					   var index = layedit.build('content'); //建立编辑器
					   var form = layui.form();
					   //获取地区
					   
					   initGrade(form);  //初始化年级
					   
//					   webUploaderInit();
					   
					   var pro = {
					       parentId : 0
					    }
					 
					    postRemote("user/tagServlet.do?flag=getRegionList3_0_1",pro,getProvinceData,form);
					    postRemote("user/tagServlet.do?flag=getSchoolList3_0_1",'',initSchool,form);
//					     var active = {
//							    content: function(){
//							      alert(layedit.getContent(index)); //获取编辑器内容
//							    }
//							    ,text: function(){
//							      alert(layedit.getText(index)); //获取编辑器纯文本内容
//							    }
//							    ,selection: function(){
//							      alert(layedit.getSelection(index));
//							    }
//							  };
					    
					   form.verify({
						    title: function(value){
						      if(value.length == 0){
						        return '标题不得为空';
						      }
						      if(value.length >15 ){
						        return '标题过长，不得超过15字';
						      }
						    }
                   });
					 
					  //监听提交
					  form.on('submit(up)', function(data){
					  	 //文本框内容
					  	var arr = { 
					  	   content : layedit.getText(index),
					  	   picture : picture
					  	}
					  	 //组合提交全部数据
					  	var postData = $.extend( true, arr, data.field);
					    //推送官方消息
					    postRemote("platform/noticeServlet.do?flag=addNotice3_0_1",postData,pushSuccessCallBack,form); 
					    return false;
					  });
					    
					    //提交省份id，获取县级
					   form.on('select(province)', function(data){
						   	    var postProData = {
					   	    	parentId : data.value
					   	    }
					   	    postRemote("user/tagServlet.do?flag=getRegionList3_0_1",postProData,getCityData,form); 
						});
					  
					   
					});
			</script>
	</body>
</html>
