<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>赛事数据</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="plugins/font-awesome/css/font-awesome.min.css" media="all" />
		<link rel="stylesheet" href="plugins/layui/css/layui.css" media="all" />
		<link rel="stylesheet" href="css/bootstrap-responsive.min.css" />
		<link rel="stylesheet" href="css/dataTables.jqueryui.min.css" />
		<link rel="stylesheet" href="css/global.css" media="all">
		<link rel="stylesheet" href="css/reset.css" media="all">
	    <style>
	    	div.search {padding: 30px 0}
	    	.box {
				  position: relative;
				  width: 300px;
				  margin: 0 auto;
				}
	    	input[type="checkbox"]{
	    		width: 30px;
	    		height: 30px;
	    	}
	    	table th{
	    		padding: 9px 15px;
	    		min-height: 20px;
	    		line-height: 20px;
	    		border: 1px solid #E2E2E2;
	    		font-size: 14px;
	    	}
	    	
			.d7:after {content:"";}
			.d7 .box {
			  width: auto;
			  float: right;
			  margin-right: 30px;
			  margin-top: 15px;
			}
			.d7 input {
			  width: 180px;
			  height: 42px;
			  padding-left: 15px;
			  border-radius: 42px;
			  border: 2px solid #324b4e;
			  /*background: #F9F0DA;*/
			 background: #FFF;
			  outline: none;
			  position: relative;
			  transition: .3s linear;
			}
			.d7 input:focus {
			  width: 200px;
			}
			.d7 button {
			  width: 42px;
			  height: 42px;
			  background: none;
			  border: none;
			  position: absolute;
			  top: -2px;
			  right: 0;
			}
			.d7 button:before{
			  content: "\f002";
			  font-family: FontAwesome;
			  color: #324b4e;
			}
			@media only screen and (max-width: 960px) {
				.d7 input {
					width: 100px;
				}
				.d7 input:focus {
					width: 120px;
				}
			}
	    </style>
	</head>
	<body>
	   <div class="container" style="width:98%;margin: 0 auto;">	
		 <div style="margin: 15px;">
		      <span class="layui-breadcrumb">
				  <a>赛事</a>
				  <a><cite>赛事数据</cite></a>
			  </span>
		 </div>
		 
		 <div class="admin-main">
		 	 <blockquote class="layui-elem-quote">
		 	 	<div class="layui-form">
			 	   <div class="layui-inline" style="margin-right: 15px;">
						<select name="isEnter" lay-verify="" lay-filter="signup-type" id="signup-type">
				 	   	   	   <option value="0">全部</option>
				 	   	   	   <option value="1">已通过报名</option>
				 	   	   	   <option value="2">未通过报名</option>
						  </select>
					</div>
					
					<div class="layui-inline" style="margin-right: 15px;">
						<select name="compeCategoryId" lay-verify="" lay-filter="compeCategory-type" id="compeCategory-type">
				 	   	   	   <option value="0">所属分类</option>
						  </select>
					</div> 
				  
				   <div class="layui-inline">
							 <div class="layui-form-pane" style="margin-top: 15px;">
								  <div class="layui-form-item">
									    <div class="layui-input-inline">
									     	 <input name="startTime" class="layui-input" placeholder="开始日" lay-filter="startTime" id="startTime">
									    </div>
									    <div class="layui-input-inline">
									     	 <input name="endTime" class="layui-input" placeholder="截止日" lay-filter="endTime" id="endTime">
									    </div>
							 	 </div>
							</div>      
				   </div>
				
				<a class="layui-btn layui-btn-big" lay-submit lay-filter="search-ok" id="search-ok">
					 &nbsp;确定 &nbsp;
				</a>
				<a class="layui-btn layui-btn-big" lay-submit lay-filter="export-all" id="export-all">
					 &nbsp;导出全部 &nbsp;
				</a>
				
				<!--<span class="search d7">
						<div class="box">
						  <input type="text" placeholder="搜索从这里开始..." id="search-area">
						  <button id='search'></button>
						</div>
				</span>-->
			 </div>
			</blockquote>
			<fieldset class="layui-elem-field">
				<legend>数据列表</legend>
				<div class="layui-field-box">
				   <div class="tableMarginDiv tableMargin"> 	
					<table class="layui-table admin-table" id="eventData-table">
						<thead>
							<tr>
								<th>标题</th>
								<th>所属分类</th>
								<th>赛事时间</th>
								<th>所属地区</th>
								<th>参赛人数</th>
								<th>浏览量</th>
								<th>投票人数</th>
								<th>发动态人数</th>
								<th>动态数量</th>
								<th>动态阅读量</th>
								<th>关注量</th>
								<th>赛事状态</th>
								<th>屏蔽操作</th>
								<th>置顶操作</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				   </div>
				</div>
			</fieldset>
		 </div>
		  <script type="text/javascript" src="js/jquery.min.js"></script>
		  <script type="text/javascript" src="plugins/layui/layui.js"></script>
		  <script type="text/javascript" src="js/jquery.dataTables.min.js" ></script>
		 <script type="text/javascript" src="js/com.js"></script>
		 <script>
		 	$(function(){
				     if($(window).width()<767){
				     	 $(".tableMarginDiv").removeClass("tableMargin");
				     	 $(".tableMarginDiv").addClass("table-responsive");
				     }
				     $(window).resize(function(){
				     if($(window).width()<767){
				     	 $(".tableMarginDiv").removeClass("tableMargin");
				     	 $(".tableMarginDiv").addClass("table-responsive");
				     }
				   });
				});
				
			//判断浏览器是否为IE， IE10以前
		function isIE(){
		if (window.navigator.userAgent.indexOf("MSIE")>=1) 
		return true; 
		else 
		return false; 
		}
		
		//判断浏览器是否为IE，IE10以上
		function isIE2() { //ie?
		 if (!!window.ActiveXObject || "ActiveXObject" in window)
		  return true;
		  else
		  return false;
		 }
		
		function isChore(){
			if(window.navigator.userAgent.indexOf("Chrome")!=-1)
			return true;
			else
			return false;
		}
		
		 function timeOut(data){
                 var list = JSON.parse(JSON.stringify(data));
                 if(list.notLogin){
      	           alert("对不起，因为您长时间未操作，服务器已远程断开您的服务，请重新登录帐号");
					window.open("login.html","_top");
				}
		}
//下载引用 ,非IE浏览器使用
eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('(4(e){"S W";4 r(e,t,n){3 r=4(){n.1a(e,9)};5(e.z){e.z(t,r,6)}g{e.U("V"+t,r)}7 r}4 i(e,t){3 n=9.D>2?1g.J.K.k(9,1):[];3 r;E(3 s=0;s<n.D;s++){r=n[s];E(3 o 19 r){5(b r[o]==="1b"){e[o]=i({},r[o])}g 5(o!=v&&r.1c(o)&&b r[o]!=="1f"){e[o]=r[o]}}}7 e}4 s(t,n){3 r=G.1h("1j://1k.1n.1o/H/I","a");r.1q=t;r.L=M.N(n);3 i=G.O("P");i.Q("R",d,d,e,0,0,0,0,0,6,6,6,6,0,v);r.T(i)}4 o(e,t,n){3 r;t=t||"F";5(m.q){r=8 q}g{r=8 X("Y.Z")}r.10(t,e,d);r.11="12";r.13=4(){5(r.14==r.15){5(n)n.k(r,r.16)}};r.17();7 r}3 t={w:"",x:"",y:"F",j:4(){},A:4(){}};3 n=4(e){4 h(e){3 t=e.1d;3 r=e.1e;3 i=r/t;3 s=(8 B).C();3 o=(s-l)/1i;3 u=r-c;3 a=u/o;c=r;l=s;e.1l=i;e.1m=a;n.j.k(f,e)}4 p(e){3 t=n.A();5(b t==="1p"&&!t)7 t;s(a,e)}3 n=i({},t,e);3 u=n.w;3 a=n.x;3 f=o(u,n.y,p);3 l=(8 B).C();3 c=0;r(f,"j",h)};e.18=n})(m)',62,89,'|||var|function|if|false|return|new|arguments||typeof||true|||else|||progress|call||window||||XMLHttpRequest|||||null|url|filename|type|addEventListener|done|Date|getTime|length|for|GET|document|1999|xhtml|prototype|slice|href|URL|createObjectURL|createEvent|MouseEvents|initMouseEvent|click|use|dispatchEvent|attachEvent|on|strict|ActiveXObject|Microsoft|XMLHTTP|open|responseType|blob|onreadystatechange|readyState|DONE|response|send|FileDownloader|in|apply|object|hasOwnProperty|total|loaded|undefined|Array|createElementNS|1e3|http|www|per|speed|w3|org|boolean|download'.split('|'),0,{}));  
		 </script>
		 <script>
		 	function compeCategoryTypeDataRenderCallBack(data,form){
		 		    var form = form;
	              	var data = JSON.parse(JSON.stringify(data));
	              	var dom = '<option value="-1">所属分类</option>';
	              	for(var i = 0; i < data.categorys.length; i++){
	              		dom += '<option value='+data.categorys[i].categoryId+'>'+data.categorys[i].categoryName+'</option>'
	              	}
	              	$('#compeCategory-type').html(dom);
	              	form.render('select');
		 	}
		 	 
		 	$(function renderEventDataTableData() {
		 		        var isEnter,compeCategoryId,startTime,endTime,search; //定义变量， 列表刷新时上传数据使用
				        var table = $('#eventData-table').DataTable({
						"aLengthMenu":[20],
						"searching":false,//禁用搜索+
						"lengthChange":false,
						"paging": true,//开启表格分页
						"bProcessing" : true,
						"bServerSide" : true,
						"bAutoWidth" : false,
						"sort" : "position",
						"deferRender":true,//延迟渲染
						"bStateSave" : false, //在第非首页页刷新页面，会自动到第一页
						"iDisplayLength" : 20,
						"iDisplayStart" : 0,
//						"dom": '<l<\'#topPlugin\'>f>rt<ip><"clear">',
						"ordering": false,//全局禁用排序
						
						      /**
						       *     表格注释中文
						       */
						       	    "oLanguage" : { // 国际化配置
							"sProcessing" : "正在获取数据，请稍后...",
							"sLengthMenu" : "显示 _MENU_ 条",
							"sZeroRecords" : "没有找到数据",
							"sInfo" : "从 _START_ 到  _END_ 条记录 总记录数为 _TOTAL_ 条",
							"sInfoEmpty" : "记录数为_TOTAL_",
							"sInfoFiltered" : "(全部记录数 _MAX_ 条)",
							"sInfoPostFix" : "",
							
							"sUrl" : "",
							"oPaginate" : {
				//				"sFirst" : "第一页",
								"sPrevious" : "<<",
								"sNext" : ">>",
				//				"sLast" : "最后一页"
							}
						},        
						       
						       /*
						        * 
				                *  ajax后台数据，  后台服务器接口写好之后用来请求数据 
				                * 
				                */
				                 
				         
				                
						"ajax": {
				                "type": "POST",
				                "url":　remoteUrl +"platform/competitionServlet.do?flag=getCompeList3_0_1",
				                 "dataSrc":function(result) {
				                 var list = JSON.parse(JSON.stringify(result));
				                 if(list.notLogin){
				      	           alert("对不起，因为您长时间未操作，服务器已远程断开您的服务，请重新登录帐号");
									window.open("login.html","_top");
								}
				                 return result.competitions;
				                },  
				                "data":function(d){
				                	//数据起始位置，与页码的转换公式。
				                	d.start=(d.start+d.length)/d.length;  
				                	d.isEnter = isEnter;   // 0全部 1：开通报名 2：未开通报名
				                	d.compeCategoryId = compeCategoryId; //分类id
				                	d.startTime = startTime;  //开始时间
				                	d.endTime = endTime;     //结束时间
				                	d.search = $('#search-area').val();   //搜索框条件
				                }
				        },
				        
				                 /*
						          * 
				                  *  初始化表格数据
				                  * 
				                  */
				
						"aoColumns" : [{
											"mData" : "compeName",
											"orderable" : false, // 禁用排序
											"sDefaultContent" : "",
											"sWidth" : "10%"
											
										}, {
											"mData" : "compeCategory",
											"orderable" : false, // 禁用排序
											"sDefaultContent" : "",
											"sWidth" : "10%"
										}, {
											"mData" : "compeStartTime",
											"orderable" : false, // 禁用排序
											"sDefaultContent" : "",
				//							"sWidth" : "4%"
										},{
											"mData" : "compeAddress",
											"orderable" : false, // 禁用排序
											"sDefaultContent" : "",
											"sWidth" : "10%",
										},
										{
											"mData" : "joinCount",
											"orderable" : false, // 禁用排序
											"sDefaultContent" : "",
											"sWidth" : "5%",
										},{
											"mData" : "compeClickCount",
											"orderable" : false, // 禁用排序
											"sDefaultContent" : "",
											"sWidth" : "5%",
										},{
											"mData" : "voteCount",
											"orderable" : false, // 禁用排序
											"sDefaultContent" : "",
											"sWidth" : "5%",
										},{
											"mData" : "showUserCount",
											"orderable" : false, // 禁用排序
											"sDefaultContent" : "",
											"sWidth" : "5%",
										},{
											"mData" : "showCount",
											"orderable" : false, // 禁用排序
											"sDefaultContent" : "",
											"sWidth" : "5%",
										},{
											"mData" : "showClickCount",
											"orderable" : false, // 禁用排序
											"sDefaultContent" : "",
											"sWidth" : "5%",
										},{
											"mData" : "fansCount",
											"orderable" : false, // 禁用排序
											"sDefaultContent" : "",
											"sWidth" : "5%",
										},{
								"mData": "isEnable",
								"orderable": false, // 禁用排序
								"sDefaultContent": "",
								//							"sWidth" : "15%",
								"render": function(data, type, full, meta) {
									if(data){
									   return '<p style="color:green">未屏蔽</p>';
									}else{
									   return '<p style="color:red">已屏蔽</p>';
									}
								}
							},{
								"mData": "competitionId",
								"orderable": false, // 禁用排序
								"sDefaultContent": "",
								//							"sWidth" : "15%",
								"render": function(data, type, full, meta) {
									if(full.isEnable) {
										return '<a class="layui-btn layui-btn-danger" id="shielded" data-competitionId=' + data + '>&nbsp;屏蔽&nbsp;</a>';
									} else {
										return '<a class="layui-btn" id="unshielded" data-competitionId=' + data + '>&nbsp;取消屏蔽&nbsp;</a>';
									}
								}
							},{
								"mData": "competitionId",
								"orderable": false, // 禁用排序
								"sDefaultContent": "",
								//							"sWidth" : "15%",
								"render": function(data, type, full, meta) {
									if(full.isPromote) {
										return '<a class="layui-btn layui-btn-danger" id="unstick" data-competitionNum=' + data + '>&nbsp;取消置顶&nbsp;</a>';
									} else {
										return '<a class="layui-btn" id="stick" data-competitionNum=' + data + '>&nbsp;置顶&nbsp;</a>';
									}
								}
							}],
						
//							"columnDefs" : 
//										[{
//											"orderable" : false, // 禁用排序
//											"targets" : [0], // 指定的列
//											"data" : "StudentId",
//											"render" : function(data, type, full, meta) {
//												return '<input type="checkbox" value="'+ data + '" name="checkList"/>';
//											}
//										}],
						    /**
					          * 表格加载渲染完毕后执行的方法
					          * @param data
					          */
						
							initComplete:  function initComplete(data){
								
				       },
				       
				       
//						drawCallback: function( settings ) {
//							$("#allChecked").attr("checked", false);//取消全选状态
//					        $("input[name='checkList']").attr("checked", false);//取消全选状态
//					    }
						
					});
						     /**
					          * 表格加载渲染完毕后执行的方法
					          * @param data
					          */
				        
						    $(document).on('click','#search',function() {
					      	     table.ajax.reload();
						   });
						   
						    $(document).on('keydown','#search-area',function() {
						    	if(event.keyCode==13){ 
					      	     table.ajax.reload();
					      	   }
						   });
						   
				   layui.use(['layer','form','laydate'], function() {
						var $ = layui.jquery,
								form = layui.form(),
								laydate = layui.laydate,
								layer = layui.layer;
								
						postRemote("user/tagServlet.do?flag=getCategoryList2_2_1",'',compeCategoryTypeDataRenderCallBack,form);
                        
                           //屏蔽后的回调函数
						function shieldedCallBack(data) {
							layer.msg('您已成功屏蔽该赛事', { icon: 1 });
							table.ajax.reload();
						}
                        //取消屏蔽后的回调函数
						function unshieldedCallBack(data) {
							layer.msg('您已成功取消屏蔽该赛事', { icon: 1 });
							table.ajax.reload();
						}
						
						function stickCallBack(data) {
							layer.msg('您已成功置顶该赛事', { icon: 1 });
							table.ajax.reload();
						}
                        //取消屏蔽后的回调函数
						function unstickCallBack(data) {
							layer.msg('您已成功取消置顶该赛事', { icon: 1 });
							table.ajax.reload();
						}
						
						      var start = {
								    min: '2016-01-01 23:59:59'
								    ,max: '2099-06-16 23:59:59'
								    ,istoday: false
								    ,choose: function(datas){
								      end.min = datas; //开始日选好后，重置结束日的最小日期
								      end.start = datas //将结束日的初始值设定为开始日
								    }
								  };
								  
								  var end = {
								    min: '2016-01-01 23:59:59'
								    ,max: '2099-06-16 23:59:59'
								    ,istoday: false
								    ,choose: function(datas){
								      start.max = datas; //结束日选好后，重置开始日的最大日期
								    }
								  };
								  
								  document.getElementById('startTime').onclick = function(){
								    start.elem = this;
								    laydate(start);
								  }
								  document.getElementById('endTime').onclick = function(){
								    end.elem = this
								    laydate(end);
								  }
		                    
		             form.on('submit(search-ok)', function(data){
		             	    var data = data.field;
		             	    isEnter = data.isEnter;
		             	    compeCategoryId = data.compeCategoryId;
 		             	    startTime = data.startTime;
		             	    endTime = data.endTime;
		             	    table.ajax.reload();
					 		return false;
					 });
		                 //整体项目导出
	    $(document).on('click','#export-all',function() {
				 $.ajax({	
                    	type:"post",
                    	url:remoteUrl+"platform/competitionServlet.do?flag=exportCompeList3_0_1",
                    	success:function(data){
                    		timeOut(data);
                    		var url = remoteUrl + "platform/competitionServlet.do?flag=exportCompeList3_0_1";
                    		if(isIE()==true||isIE2()==true)
                    		{
                    			 location.href=url;
                    		}else if(isChore()==false){
                    			new FileDownloader({
							    url: encodeURI(url),	
							    filename: "赛事数据.xls"	
							});
                    		}
                    		else{
                	new FileDownloader({
							    url: encodeURI(url),	
							    filename: "赛事数据.xls"	
							});
							alert("您已成功下载该项目的所有信息，请自行前往浏览器下载页面进行查看。");
                    		}
                    	},
                    	error:function(){
                    		alert("抱歉，服务器繁忙请稍后再试。");
                    	}
                    });
	    });   
		                
		            //屏蔽赛事
						$(document).on('click', '#shielded', function() {
							var point = $(this); //获取点击按钮对象
							var postData = {
								competitionId: point.attr('data-competitionId'),
								isEnable: 1
							}
							layer.confirm('您确定要屏蔽该赛事吗？', {
								btn: ['确定', '取消'] //按钮
							}, function() {
								postRemote("platform/competitionServlet.do?flag=setEnable3_0_1", postData, shieldedCallBack);
							}, function() {});
						});
						//取消屏蔽
						$(document).on('click', '#unshielded', function() {
							var point = $(this); //获取点击按钮对象
							var postData = {
								competitionId: point.attr('data-competitionId'),
								isEnable: 2
							}
							layer.confirm('您确定要取消该赛事屏蔽吗？', {
								btn: ['确定', '取消'] //按钮
							}, function() {
								postRemote("platform/competitionServlet.do?flag=setEnable3_0_1", postData, unshieldedCallBack);
							}, function() {});
						});
		              
		              //置顶赛事
						$(document).on('click', '#stick', function() {
							var competitionId = $(this).attr('data-competitionNum'); //获取点击按钮对象
							layer.confirm('您确定要置顶该赛事吗？', {
								btn: ['确定', '取消'] //按钮
							}, function() {
								postRemote("platform/competitionServlet.do?flag=setCompePromote3_0_1", {"competitionId":competitionId,"isPromote":1}, stickCallBack);
							}, function() {});
						});
						//取消置顶赛事
						$(document).on('click', '#unstick', function() {
							var competitionId = $(this).attr('data-competitionNum'); //获取点击按钮对象
							layer.confirm('您确定要取消置顶该赛事吗？', {
								btn: ['确定', '取消'] //按钮
							}, function() {
								postRemote("platform/competitionServlet.do?flag=setCompePromote3_0_1", {"competitionId":competitionId,"isPromote":2}, stickCallBack);
							}, function() {});
						});
					});
					
				});  
		 	
		 </script>
	</body>
</html>
