<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>发布赛事</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no;" />
		<meta name="keywords" content="" />
	    <meta name="description" content="" />
	    <meta name="author" content="www.keyweb.cn" />
		<link rel="stylesheet" href="plugins/layui/css/layui.css" media="all" />
		<link rel="stylesheet" href="css/webuploader.css" media="all" />
		<link rel="stylesheet" href="css/global.css" media="all">
		<link rel="stylesheet" href="css/reset.css" media="all">
		<style>
			#mapAddressModal{position:fixed;background:#fff;z-index:999;display:none;top:0;overflow:hidden;width:100%;padding:0;margin:0;left:0}
			#mapAddressModal iframe{margin:0;padding:0;border:0;overflow:hidden;width:100%;}
			.hide{display: none;}
		</style>
	</head>
	<body>
	   <div class="container" style="width: 70%;">	
		 <div style="margin: 15px;">
		      <span class="layui-breadcrumb">
				  <a>赛事</a>
				  <a>发布赛事</a>
				  <a><cite>发布</cite></a>
			  </span>
		 </div>
		 
		 <div class="layui-form" style="margin: 17px;">
		 	<div class="layui-form-item">
		 	   <div class="layui-inline">
		     	 <div id="uploadimg"> 
						 <div id="fileList" class="uploader-list"></div> 
						 <div id="imgPicker">选择图片</div> 
					</div>
			    </div>
			    
			    <div class="layui-inline">
			    	 <p style="color: #D2D2D2" id="showstatus">选取的图片尺寸大于100*50,大小应小于512K。<p>
		          	 <p style="color: #D2D2D2" id="showsize">只能上传1张</p>
			    </div>
		    </div>
		 	
		 	<div class="layui-form-item">
				 <div class="layui-input-inline" style="width: 75%">
		             <input type="text" name="compeName" required="" lay-verify="title" placeholder="赛事名称" autocomplete="off" class="layui-input" id="compeName">
		          </div>
		 	 </div> 
		 	
		 	<div class="layui-form-item">
				 <div class="layui-input-inline" style="width: 75%">
		             <input type="text" name="compeSponsor" required="" lay-verify="title" placeholder="请输主办方" autocomplete="off" class="layui-input" id="compeSponsor">
		          </div>
		 	 </div> 
		 	 
		 	 <div class="layui-form-item">
				 <div class="layui-input-inline" style="width: 75%">
		             <input type="text" name="compeCoSponsor" required="" lay-verify="title" placeholder="请输入承办方" autocomplete="off" class="layui-input" id="compeCoSponsor">
		          </div>
		 	 </div> 
		 	 
		 	 <div class="layui-form-item">
				 <div class="layui-input-inline" style="width: 75%">
		             <input type="text" name="compeURL" required="" lay-verify="url" placeholder="请输入官网地址" autocomplete="off" class="layui-input" id="compeURL">
		          </div>
		 	 </div> 
		 	
		 	<div class="layui-form-item">
		 	   <div class="layui-inline">
			 	   	   <select name="compeSchoolId" lay-verify="" lay-filter="compeSchoolId" id="school">
							  <option value="">请选择所属学校(选填)</option>
					   </select>
		 	   </div>
		 	   
		 	   <div class="layui-inline">
			 	   <div class="layui-input-inline" style="width: 298.5%">
		             <input type="text" name="compeCampus" required="" lay-verify="title" placeholder="请输入所属校区" autocomplete="off" class="layui-input" id="compeCampus">
		           </div>
		 	   </div>
		 	</div>   
		 	
		 	<div class="layui-form-item" style="position:relative">
		 		<input  id="compeLongitude" name="compeLongitude" value="" type="hidden"/>
                <input  id="compeLatitude" name="compeLatitude" value="" type="hidden"/>
				 <div class="layui-input-inline" style="width: 75%">
		             <input type="text" name="compeAddress" required="" placeholder="请输入举办地点(选填)" autocomplete="off" class="layui-input" id="compeAddress">
		          </div>
		 		 <i class="layui-icon" style="font-size: 30px; color: #1E9FFF;position: absolute;top:10%;right:25%;margin-right:5px;" onclick="showMapAddressModal()">&#xe609;</i> 
		 	 </div> 
		     
		     <div class="layui-form-item">
				 <div class="layui-input-inline">
					  <input name="compeEnterStart" class="layui-input" placeholder="报名开始时间" lay-filter="compeEnterStart" id="compeEnterStart">
				 </div>
				 <div class="layui-form-mid">至</div>
				 <div class="layui-input-inline">
						 <input name="compeEnterEnd" class="layui-input" placeholder="报名结束时间" lay-filter="compeEnterEnd" id="compeEnterEnd">
				 </div>
		 	 </div> 
		 	 
		 	 <div class="layui-form-item">
				 <div class="layui-input-inline">
					  <input name="compeStartTime" class="layui-input" placeholder="竞赛开始时间" lay-filter="compeStartTime" id="compeStartTime">
				 </div>
				 <div class="layui-form-mid">至</div>
				 <div class="layui-input-inline">
						 <input name="compeEndTime" class="layui-input" placeholder="竞赛结束时间" lay-filter="compeEndTime" id="compeEndTime">
				 </div>
		 	 </div> 
		     
		     <div class="layui-form-item">
		         	  <label class="layui-form-label" style="font-size: 16px;">标签</label>
					    <div class="layui-input-block" id="projectCategoryBox">
					  </div>
		     </div>
		     
		     <div class="layui-form-item">
		     	  <div class="layui-block-inline">
					   <label class="layui-form-label" style="font-size: 16px;">开通报名</label>
					   <input type="checkbox" name="close" lay-skin="switch" lay-text="是|否">
				 </div>
				 
			    <span class="voteArea hide"> 
					 <label class="layui-form-label" style="font-size: 16px;">投票</label>
						    <div class="layui-input-block" id="voteBox">
						       <input type="radio" name="vote" value="1" title="单选投票">
	      						<input type="radio" name="vote" value="2" title="多选投票">
						  </div>
			    </span>
		     </div>
		     
		     <div class="layui-form-item">
		     	  <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
				     <legend>请填写比赛介绍</legend>
				  </fieldset>
		     	  
		      	  <textarea id="content" style="display: none;"></textarea>
		     </div>
		   </div>
		   
		    <div style="margin-left:43%;margin-bottom: 30px;">
		    	<button class="layui-btn layui-btn-big" id="fabu">提交</button>
		    </div>
		 </div>
		 <!--地图-->
		    <div id="mapAddressModal">
		        <iframe src="" ></iframe>
		    </div>
		 <script type="text/javascript" src="js/jquery.min.js"></script>
		 <script type="text/javascript" src="js/webuploader.min.js"></script>
		 <script type="text/javascript" src="plugins/layui/layui.js"></script>
		 <script type="text/javascript" src="m-files/bootstrap.js"></script>
		 <script type="text/javascript" src="js/com.js"></script>
		 <script type="text/javascript" src="js/underscore-min.js"></script>
		 <script>
         var picture,compeIntroduction,isEnter,isSingleVote;  
		 
		 function saveProjectCallback(result,layer) {
		 	$("#fabu").addClass("layui-btn-disabled");
		 	
            if (result.stateCode == 0) {
            	layer.msg('发布成功!', {icon: 1});
            	$("#fabu").removeClass("layui-btn-disabled");
                return;
            } else if (result.stateCode == 1) {
            	layer.msg('未登录！', {icon: 2});
            	$("#fabu").removeClass("layui-btn-disabled");
                return;
            } else if (result.stateCode == 2) {
            	layer.msg('信息不能为空！', {icon: 2});
            	$("#fabu").removeClass("layui-btn-disabled");
                return;
            } else if (result.stateCode == 3) {
            	layer.msg('保存失败！', {icon: 2});
            	$("#fabu").removeClass("layui-btn-disabled");
                return;
            } else if (result.stateCode == 4) {
            	layer.msg('企业未认证！', {icon: 2});
            	$("#fabu").removeClass("layui-btn-disabled");
                return;
            } else if (result.stateCode == 5) {
            	layer.msg('报名时间不在参赛时间之前！', {icon: 2});
            	$("#fabu").removeClass("layui-btn-disabled");
                return;
            } else if (result.stateCode == 6) {
            	layer.msg('开始时间不能大于结束时间！', {icon: 2});
            	$("#fabu").removeClass("layui-btn-disabled");
                return;
            } else {
            	layer.msg('未知错误', {icon: 2});
            	$("#fabu").removeClass("layui-btn-disabled");
                return;
            }
        }
		 
		 function saveProject(layer){
		 	
            if ($("#compeName").val() == "") {
            	layer.msg('赛事名称不能为空！', {icon: 2});
                return;
            }



            if ($("#compeEnterStart").val() == "") {
            	layer.msg('报名开始时间不能为空！', {icon: 2});
                return;
            }
            if ($("#compeEnterEnd").val() == "") {
            	layer.msg('报名结束时间不能为空！', {icon: 2});
                return;
            }
            
            if(picture === undefined){
            	layer.msg('请上传海报图片！', {icon: 2});
                return;
            }

//          var compeEnterStartStr = $("#compeEnterStart").val();
//          var compeEnterStart = new Date(compeEnterStartStr.replace(/-/, "/"));
//
//          var compeEnterEndStr = $("#compeEnterEnd").val();
//          var compeEnterEnd = new Date(compeEnterEndStr.replace(/-/, "/"));
//
//          if (compeEnterStart - compeEnterEnd > 0) {
//              showMsg("报名开始时间不能大于结束时间！", "error");
//              $("#compeEnterStart").focus();
//              return;
//          }
//
            if ($("#compeStartTime").val() == "") {
            	layer.msg('赛事开始时间不能为空！', {icon: 2});
                return;
            }
            if ($("#compeEndTime").val() == "") {
            	layer.msg('赛事结束时间不能为空', {icon: 2});
                return;
            }
            
            if(!$(".voteArea").hasClass("hide")){
            	if(isSingleVote==""){
            		layer.msg('请选择投票方式', {icon: 2});
                	return;
            	}
            };
//          var compeStartTime = $("#compeStartTime").val();
//          var compeStartTimeStr = $("#compeStartTime").val();
//          var compeStartTime = new Date(compeStartTimeStr.replace(/-/, "/"));
//          var compeEndTimeStr = $("#compeEndTime").val();
//          var compeEndTimeStr = $("#compeEndTime").val();
//          var compeEndTime = new Date(compeEndTimeStr.replace(/-/, "/"));

//          if (compeStartTime - compeEndTime > 0) {
//              showMsg("赛事开始时间不能大于结束时间！", "error");
//              $("#compeStartTime").focus();
//              return;
//          }

//          if ($("#compeAddress").val() == "") {
//          	layer.msg('举办地点不能为空！', {icon: 2});
//              return;
//          }

//          if ($("#compeLongitude").val() == "") {
//          	layer.msg('请选择竞赛地点地图坐标！', {icon: 2});
//              return;
//          }

//          if ($("#compeIntroduction").val() == "") {
//          	layer.msg('赛事介绍描述不能为空！', {icon: 2});
//              return;
//          }
            if($(".layui-form-radioed").prev("input").val()===undefined){
            	layer.msg('必须选择赛事标签', {icon: 2});
                return;
            }
            
            if(compeIntroduction==""){
            	layer.msg('赛事介绍描述不能为空！', {icon: 2});
                return;
            }
//          if ($("input[name='projectPic']").val() == "") {
//              showMsg("封面图片不能为空！", "error");
//              return;
//          }
            
//          if ($("dd.layui-this").attr("lay-value")==-1) {
//              layer.msg('请选择学校！', {icon: 2});
//              return;
//            }
//          
//          if($("input[name='compeCampus']").val()==""){
//             	layer.msg('请填写校区！', {icon: 2});
//              return;
//          }
            
              if ($("#compeURL").val()=="") {
                layer.msg('赛事官网不能为空！', {icon: 2});
                return;
              }

            postRemote("company/competitionServlet.do?flag=publishCompetition2_2_1", {
                compeCategory: $("#projectCategoryBox .layui-form-radioed").prev("input").val(),
                compeName: $("input[name='compeName']").val(),
                compeEnterStart: $("input[name='compeEnterStart']").val(),
                compeEnterEnd: $("input[name='compeEnterEnd']").val(),
                compeStartTime: $("input[name='compeStartTime']").val(),
                compeEndTime: $("input[name='compeEndTime']").val(),
                compeAddress: $("input[name='compeAddress']").val(),
                compeLongitude: $("input[name='compeLongitude']").val(),
                compeLatitude: $("input[name='compeLatitude']").val(),
                compeSchoolId: $("dd.layui-this").attr("lay-value"),
                compeCampus:$("input[name='compeCampus']").val(),
                compePicture: picture,
                compeSponsor: $("#compeSponsor").val(),
                compeCoSponsor: $("#compeCoSponsor").val(),
                compeIntroduction: compeIntroduction,
                compeURL: $("#compeURL").val(),
                isEnter: isEnter,
                isSingleVote: $("#voteBox .layui-form-radioed").prev("input").val()
            }, saveProjectCallback, layer);
        }
		 
	function showMapAddressModal() {
         $("#mapAddressModal iframe").attr("src", "gdmap.html?lng=" + $("#compeLongitude").val() + "&lat=" + $("#compeLatitude").val());
            $("#mapAddressModal").show();

            $("#mapAddressModal iframe").css("height", $(window).height() + "px");

        }

        function cancelAddress() {
            $("#mapAddressModal").hide();
        }

        function setAddress(address, lng, lat) {
            $("#mapAddressModal").hide();
            $("#compeAddress").val(address);
            $("#compeLongitude").val(lng);
            $("#compeLatitude").val(lat)
        }
        
        function setIframe() {
//          var w = $("body").width();
            //var h = $(".moreBox").offset().top + $(".moreBox").height();alert(h)
            var w = window.screen.availWidth;
            var h = window.screen.availHeight;
            $("#mapAddressModal").css("top", "0px");
            $("#mapAddressModal").css("width", w + "px");
            $("#mapAddressModal").css("height", h + "px");

            $("#mapAddressModal iframe").css("width", w + "px");
            $("#mapAddressModal iframe").css("height", h + "px");
        }
        $(window).resize(function () {
            setIframe();
        });
		 	 
		 	 $(function webUploaderInit(){
			        var uploader = WebUploader.create({ 
							 auto: true, // 选完文件后，是否自动上传 
							 swf: '/js/Uploader.swf', // swf文件路径 
							 server: remoteUrl + 'student/projectServlet.do?flag=uploadPicture', // 文件接收服务端 
							 pick: '#imgPicker', // 选择文件的按钮。可选 
							 // 只允许选择图片文件。 
							 accept: { 
							 title: 'Images', 
							 extensions: 'gif,jpg,jpeg,bmp,png'
//							 mimeTypes: 'image/*' 
							 },
							 compress: {
							 	width: 800,  
							    height: 1200,  
							  
							    // 图片质量，只有type为`image/jpeg`的时候才有效。  
							    quality: 80,  
							  
							    // 是否允许放大，如果想要生成小图的时候不失真，此选项应该设置为false.  
							    allowMagnify: false,  
							  
							    // 是否允许裁剪。  
							    crop: false,  
							  
							    // 是否保留头部meta信息。  
							    preserveHeaders: true,  
							  
							    // 如果发现压缩后文件大小比原来还大，则使用原来图片  
							    // 此属性可能会影响图片自动纠正功能  
							    noCompressIfLarger: false,  
							  
							    // 单位字节，如果图片大小小于此值，不会采用压缩。  
							    compressSize: 0  
							 }
							});
			        
			        uploader.on( 'fileQueued', function( file ) { 
							 var $list = $("#fileList"), 
							 $li = $( 
							 '<div id="' + file.id + '" class="file-item thumbnail">' + 
							 '<img>' + 
							 '<div class="info">' + file.name + '</div>' + 
							 '</div>' 
							 ), 
							 $img = $li.find('img'); 
							 
							 
							 // $list为容器jQuery实例 
							 $list.append( $li ); 
							 
							 // 创建缩略图 
							 uploader.makeThumb( file, function( error, src ) { 
							 if ( error ) { 
							 $img.replaceWith('<span>不能预览</span>'); 
							 return; 
							 } 
							 
							 $img.attr( 'src', src ); 
							 }, 100, 100 ); //100x100为缩略图尺寸 
							});
							
					// 文件上传过程中创建进度条实时显示。 
					uploader.on( 'uploadProgress', function( file, percentage, headers ) { 
					 _.extend(headers, {
							"Origin": "http://localhost:3000",
							"Access-Control-Request-Method": "POST"
							    });
							    
					 var $li = $( '#'+file.id ), 
					 $percent = $li.find('.progress span'); 
					 
					 // 避免重复创建 
					 if ( !$percent.length ) { 
					 $percent = $('<p class="progress"><span></span></p>') 
					 .appendTo( $li ) 
					 .find('span'); 
					 } 
					 
					 $percent.css( 'width', percentage * 100 + '%' ); 
					}); 
					 
					// 文件上传成功，给item添加成功class, 用样式标记上传成功。 
					uploader.on( 'uploadSuccess', function( file, res ) { 
					 $( '#'+file.id ).addClass('upload-state-done');
					 var res = JSON.parse(JSON.stringify(res));
					     picture = res.picName;
					}); 
					 
					// 文件上传失败，显示上传出错。 
					uploader.on( 'uploadError', function( file ) { 
					 var $li = $( '#'+file.id ), 
					 $error = $li.find('div.error'); 
					 
					 // 避免重复创建 
					 if ( !$error.length ) { 
					 $error = $('<div class="error"></div>').appendTo( $li ); 
					 } 
					 
					 $error.text('上传失败'); 
					}); 
					 
					// 完成上传完了，成功或者失败，先删除进度条。 
					uploader.on( 'uploadComplete', function( file ) { 
					 $( '#'+file.id ).find('.progress').remove(); 
				});
			         
		 	});
		 	 
		 	 function initSchool(data,form){
		 	 	   var form = form;
		 	 	   var data = JSON.parse(JSON.stringify(data));
		 	 	   var dom = '<option value="-1">选择学校</option>';
	              	for(var i = 0; i < data.schools.length; i++){
	              		dom += '<option value='+data.schools[i].schoolId+'>'+data.schools[i].schoolName+'</option>'
	              	}
	              	$('#school').html(dom);
	              	form.render('select');
		 	 };
		 	 
		 function getProjectBaseInfoCallback(result,form) {
		 	var  categoryForm = form;
            var projectCategory = result.categorys;
            var html = "";
            for (var i = 0; i < projectCategory.length; i++) {
                html += '<input type="radio" name="category" value='+projectCategory[i].categoryId+' title='+projectCategory[i].categoryName+'>';
            }
            $("#projectCategoryBox").html(html);
            categoryForm.render();
        }
		 </script>
		  <script>
		  	        layui.use(['layer','layedit','form','laydate'], function(){
		  	           var layer = layui.layer;
					   var layedit = layui.layedit;
					   var index = layedit.build('content'); //建立编辑器
					   var laydate = layui.laydate;
					   var form = layui.form();
					  
					  $(document).on('click','.layui-unselect.layui-form-switch',function(){
                              var point = $(this);
                              if(point.hasClass("layui-form-onswitch")){
                              	$(".voteArea").removeClass("hide");
                              }else{
                              	$(".voteArea").addClass("hide");
                              	isSingleVote = "";
                              }
					  });
					  //CE表示报名， E表竞赛
					  var startCE = {
								    min: '2016-01-01 23:59:59'
								    ,max: '2099-06-16 23:59:59'
								    ,istoday: false
								    ,choose: function(datas){
								      endCE.min = datas; //开始日选好后，重置结束日的最小日期
								      endCE.start = datas //将结束日的初始值设定为开始日
								    }
								  };
								  
					  var endCE = {
								    min: '2016-01-01 23:59:59'
								    ,max: '2099-06-16 23:59:59'
								    ,istoday: false
								    ,choose: function(datas){
								      startE.min = datas; //开始日选好后，重置结束日的最小日期
								      startCE.max = datas; //结束日选好后，重置开始日的最大日期
								    }
								  };
								  
					  var startE = {
								    min: '2016-01-01 23:59:59'
								    ,max: '2099-06-16 23:59:59'
								    ,istoday: false
								    ,choose: function(datas){
								      endE.min = datas; //开始日选好后，重置结束日的最小日期
								      endE.start = datas //将结束日的初始值设定为开始日
								    }
								  };
								  
					  var endE = {
								    min: '2016-01-01 23:59:59'
								    ,max: '2099-06-16 23:59:59'
								    ,istoday: false
								    ,choose: function(datas){
								     startE.max = datas; //结束日选好后，重置开始日的最大日期
								    }
								  };
								  
								  document.getElementById('compeEnterStart').onclick = function(){
								    startCE.elem = this;
								    laydate(startCE);
								  }
								  document.getElementById('compeEnterEnd').onclick = function(){
								    endCE.elem = this
								    laydate(endCE);
								  }
								  
								  document.getElementById('compeStartTime').onclick = function(){
								    startE.elem = this;
								    laydate(startE);
								  }
								  
								  document.getElementById('compeEndTime').onclick = function(){
								    endE.elem = this
								    laydate(endE);
								  }
					   
					   //获取学校
					    postRemote("user/tagServlet.do?flag=getSchoolList3_0_1",'',initSchool,form);
					   //获取标签 
					    postRemote("user/tagServlet.do?flag=getCategoryList2_2_1", {}, getProjectBaseInfoCallback,form);
//					   
					    
					   form.verify({
						    title: function(value){
						      if(value.length == 0){
						        return '标题不得为空';
						      }
						      if(value.length >15 ){
						        return '标题过长，不得超过15字';
						      }
						    }
                   });
					 
//					  //监听提交
//					  form.on('submit(up)', function(data){
//					  	 //文本框内容
//					  	var arr = { 
//					  	   content : layedit.getText(index),
//					  	   picture : picture
//					  	}
//					  	 //组合提交全部数据
//					  	var postData = $.extend( true, arr, data.field);
//					    //推送官方消息
//					    postRemote("platform/noticeServlet.do?flag=addNotice3_0_1",postData,pushSuccessCallBack,form); 
//					    return false;
//					  });
				    $(document).on('click','#fabu',function(){
				    	 if($(".layui-unselect").hasClass("layui-form-onswitch")){
				    	 	isEnter = 1;
				    	 }else{
				    	 	isEnter = 2;
				    	 }
				    	 if($(".layui-unselect").hasClass("layui-form-onswitch")){
				    	   isSingleVote = $("#voteBox .layui-form-radioed").prev("input").val();
				    	 }else{
				    	   isSingleVote = ""; 
				    	 }
				    	 compeIntroduction = layedit.getText(index);
				    	 saveProject(layer);
				    });
				    
				    
				});
			</script>
	</body>
</html>
