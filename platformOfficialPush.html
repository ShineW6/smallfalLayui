<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>平台官方推送</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="plugins/layui/css/layui.css" media="all" />
		<link rel="stylesheet" href="css/global.css" media="all">
		<link rel="stylesheet" href="css/reset.css" media="all">
	</head>
	<body>
	   <div class="container" style="width: 70%;">	
		 <div style="margin: 15px;">
		      <span class="layui-breadcrumb">
				  <a>推送管理</a>
				  <a><cite>平台官方推送</cite></a>
			  </span>
		 </div>
		 
		<form class="layui-form">
		 <div class="layui-form" style="margin: 17px;">
		 	<div class="layui-form-item">
		 	   <div class="layui-inline">
		 	   	   <select name="provinceId" lay-verify="" lay-filter="province" id="province">
		 	   	   	   <option value="">所属省份</option>
				   </select>
		 	   </div>
		 	   
		 	   <div class="layui-inline">
			 	   	   <select name="cityId" lay-verify="" lay-filter="city" id="city">
			 	   	   	 <option value="">所属城市</option>
					   </select>
		 	   </div>
		 	   
		 	   <div class="layui-inline">
			 	   	   <select name="schoolId" lay-verify="" lay-filter="school" id="school">
							  <option value="">选择学校</option>
					   </select>
		 	   </div>
		 	   
		 	   <div class="layui-inline">
			 	   	   <select name="grade" lay-verify="" lay-filter="grade" id="grade">
			 	   	   	   <option value="">入学年份</option>
					   </select>
		 	   </div>
		 	</div>   
		 	
		 	<div class="layui-form-item">
				 <div class="layui-input-inline" style="width: 75%">
		             <input type="text" name="title" required="" lay-verify="title" placeholder="请输入标题" autocomplete="off" class="layui-input">
		          </div>
		 	 </div> 
		 	 
		 	 <div class="layui-form-item">
				 <div class="layui-input-inline" style="width: 75%">
		             <input type="text" name="url" required="" lay-verify="url" placeholder="请输入链接" autocomplete="off" class="layui-input">
		          </div>
		 	 </div>
		     
		      <div class="layui-form-item">
		      	 <div class="layui-inline">
			           <div class="site-demo-upload">
						    <img id="pictureBack" src="">
							  <div class="site-demo-upbar">
							    <input type="file" name="picturePost" class="layui-upload-file">
							  </div>
					  </div>
		          </div>
		          <div class="layui-inline">
		          	    <p style="color: #D2D2D2" id="showstatus">选取的图片尺寸大于100*100,大小应小于512K。<p>
		          	    <p style="color: #D2D2D2" id="showsize">只能上传1张</p>
		          </div>
		      </div> 
		      
		      <div class="layui-form-item">
		      	  <textarea id="content" style="display: none;"></textarea>
		      </div>
		   </div>
		   
		    <div style="margin-left:43%;margin-bottom: 30px;">
		    	<button class="layui-btn layui-btn-big" lay-submit lay-filter="up">提交</button>
		    </div>
		 </form>
		 </div>
		 <script type="text/javascript" src="js/jquery.min.js"></script>
		 <script type="text/javascript" src="plugins/layui/layui.js"></script>
		 <script type="text/javascript" src="js/com.js"></script>
		 <script>
		 	 function pushSuccessCallBack(data,form){
		 	 	   var form = form;
		 	 	   var data = JSON.parse(JSON.stringify(data));
		 	 	   if(data.stateCode==0){
		 	 	   	 layer.msg('您已成功发送此条推送', {icon: 1});
		 	 	   }
		 	 	   if(data.stateCode==1){
		 	 	   	 layer.msg('推送发送失败，内容、标题不能为空', {icon: 2});
		 	 	   }
		 	 }
		 	
		 	 function initGrade(form){
		 	 	   var form = form;
		 	 	   var dom = '<option value="-1">入学年份</option>';
 		 	 	   var now = new Date();
 		 	 	   var nowYear = now.getFullYear();
 		 	 	   for(var i=2007;i<=nowYear;i++){
 		 	 	   	dom += '<option value='+i+'>'+i+'</option>'
 		 	 	   }
 		 	 	   $('#grade').html(dom);
	              	form.render('select');
		 	 };
		 	 
		 	 function initSchool(data,form){
		 	 	   var form = form;
		 	 	   var data = JSON.parse(JSON.stringify(data));
		 	 	   var dom = '<option value="-1">选择学校</option>';
	              	for(var i = 0; i < data.schools.length; i++){
	              		dom += '<option value='+data.schools[i].schoolId+'>'+data.schools[i].schoolName+'</option>'
	              	}
	              	$('#school').html(dom);
	              	form.render('select');
		 	 };
		 	
		 	 
		 	 function getProvinceData(data,form){
	              	var form = form;
	              	var data = JSON.parse(JSON.stringify(data));
	              	var dom = '<option value="-1">所属省份</option>';
	              	for(var i = 0; i < data.regions.length; i++){
	              		dom += '<option value='+data.regions[i].regionId+'>'+data.regions[i].regionName+'</option>'
	              	}
	              	$('#province').html(dom);
	              	form.render('select');
              }
		 	 
		 	 function getCityData(data,form){
		 	 	    var form = form;
	              	var data = JSON.parse(JSON.stringify(data));
	              	var dom = '<option value="-1">所属城市</option>';
	              	if(data.regions){
		              	for(var i = 0; i < data.regions.length; i++){
		              		dom += '<option value='+data.regions[i].regionId+'>'+data.regions[i].regionName+'</option>'
		              	}
		            }
	              	$('#city').html(dom);
	              	form.render('select');
              }
		 </script>
		  <script>
		  	        layui.use(['layedit','form','upload'], function(){
		  	           var picture;
					   var layedit = layui.layedit;
					   var index = layedit.build('content'); //建立编辑器
					   var form = layui.form();
					   //获取地区
					   
					   initGrade(form);  //初始化年级
					   
					   var pro = {
					       parentId : 0
					    }
					 
					    postRemote("user/tagServlet.do?flag=getRegionList3_0_1",pro,getProvinceData,form);
					    postRemote("user/tagServlet.do?flag=getSchoolList3_0_1",'',initSchool,form);
//					     var active = {
//							    content: function(){
//							      alert(layedit.getContent(index)); //获取编辑器内容
//							    }
//							    ,text: function(){
//							      alert(layedit.getText(index)); //获取编辑器纯文本内容
//							    }
//							    ,selection: function(){
//							      alert(layedit.getSelection(index));
//							    }
//							  };
					    
					   form.verify({
						    title: function(value){
						      if(value.length == 0){
						        return '标题不得为空';
						      }
						      if(value.length >15 ){
						        return '标题过长，不得超过15字';
						      }
						    }
                   });
					 
					  //监听提交
					  form.on('submit(up)', function(data){
					  	 //文本框内容
					  	var arr = { 
					  	   content : layedit.getText(index),
					  	   picture : picture
					  	}
					  	 
					  	 //组合提交全部数据
					  	var postData = $.extend( true, arr, data.field);
					    //推送官方消息
					    postRemote("platform/noticeServlet.do?flag=addNotice3_0_1",postData,pushSuccessCallBack,form); 
					    return false;
					  });
					    
					    //提交省份id，获取县级
					   form.on('select(province)', function(data){
						   	    var postProData = {
					   	    	parentId : data.value
					   	    }
					   	    postRemote("user/tagServlet.do?flag=getRegionList3_0_1",postProData,getCityData,form); 
						});
					  
					   layui.upload({
								  url: remoteUrl + 'platform/dataServlet.do?flag=uploadPicture'
								  ,ext: 'jpg|png|jpeg|bmp'
								  ,success: function(res){
								    var res = JSON.parse(JSON.stringify(res));
								    if(res.statusCode==0){
								    	 $('#showstatus').html('上传成功').css('color','green');
								    	 $('#showsize').html(res.msg).css('color','green');
								    	 picture = res.picName;
								    	 pictureBack.src = res.picUrl;
								    }
								    if(res.statusCode==1){
								    	 $('#showstatus').html('上传失败').css('color','red');
								    	 $('#showsize').html(res.msg).css('color','red');
								    }
								    if(res.statusCode==2){
								    	 $('#showstatus').html('文件过大').css('color','red');
								    	 $('#showsize').html(res.msg).css('color','red');
								    }
								  }
								}); 
					});
			</script>
	</body>
</html>
